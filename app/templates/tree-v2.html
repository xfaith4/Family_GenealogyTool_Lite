<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tree View v2 - Family Genealogy Tool Lite</title>
  <link rel="stylesheet" href="/static/styles.css"/>
  <!-- Cytoscape.js -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <!-- ELK layout for Cytoscape -->
  <script src="https://unpkg.com/cytoscape-elk@2.2.0/cytoscape-elk.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">üå≥</div>
      <div class="title">
        <div class="name">Family Genealogy Tool <span class="muted">Lite</span> - Tree v2</div>
        <div class="sub">Graph-based navigation ‚Ä¢ Cytoscape.js + ELK</div>
      </div>
    </div>
    <div class="actions">
      <a href="/" class="btn btnSecondary">‚Üê Back to Main View</a>
      <a href="/analytics" class="btn btnSecondary">üìä Analytics</a>
      <a href="/media/unassigned" class="btn btnSecondary">üì∑ Unassigned Media</a>
      <label class="btn btnSecondary" for="gedcomFile">Import GEDCOM</label>
      <input id="gedcomFile" type="file" accept=".ged,.gedcom,.txt" hidden />
    </div>
  </header>

  <main class="gridV2">
    <section class="panel">
      <div class="panelHeader">
        <h2>Select Person</h2>
        <input id="search" class="input" placeholder="Search (given/surname)..." />
      </div>
      <div id="peopleList" class="list"></div>
    </section>

    <section class="panel treeV2Main">
      <div class="panelHeader">
        <h2>Graph Tree View</h2>
        <div class="treeV2Controls">
          <label for="depthSelect">Generations:</label>
          <select id="depthSelect">
            <option value="1">1 generation</option>
            <option value="2" selected>2 generations</option>
            <option value="3">3 generations</option>
            <option value="4">4 generations</option>
            <option value="5">5 generations</option>
          </select>
          <label for="layoutSelect">Layout:</label>
          <select id="layoutSelect">
            <option value="elk" selected>Layered (ELK)</option>
            <option value="breadthfirst">Breadthfirst</option>
            <option value="concentric">Concentric</option>
            <option value="cose">Force (COSE)</option>
          </select>
          <input id="graphSearch" class="input inputSmall" placeholder="Find in graph..." />
          <button id="btnFind" class="btn btnSecondary">Find</button>
          <button id="btnFit" class="btn btnSecondary">Fit</button>
          <button id="btnRefresh" class="btn btnSecondary" disabled>Refresh</button>
          <button id="btnExportPng" class="btn btnSecondary">Export&nbsp;PNG</button>
          <button id="btnExportTree" class="btn">Export&nbsp;CSV</button>
          <button id="btnPrintTree" class="btn btnSecondary">Print Tree</button>
        </div>
      </div>
      <div id="treeV2Container"></div>
      <div class="muted" style="margin-top: 10px; font-size: 12px;">
        üí° Click a person to see details ‚Ä¢ Drag to pan ‚Ä¢ Scroll to zoom
      </div>
    </section>
  </main>

  <div id="treeV2Panel" class="hidden"></div>

  <footer class="footer">
    <span class="muted">Tree Navigation v2 (feature preview) ‚Ä¢ Local app ‚Ä¢ Data stored in ./data/family_tree.sqlite</span>
  </footer>

  <script src="/static/tree-v2.js"></script>
  <script>
    // Shared app.js utilities (minimal copy for tree-v2)
    let state = { people: [], selected: null };
    const $ = (id) => document.getElementById(id);
    
    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    
    function fullName(p){
      const g = (p.given || "").trim();
      const s = (p.surname || "").trim();
      const name = `${g} ${s}`.trim();
      return name || "(unnamed)";
    }
    
    async function api(url, opts){
      const res = await fetch(url, opts);
      const txt = await res.text();
      let body = null;
      try { body = txt ? JSON.parse(txt) : null; } catch { body = txt; }
      if(!res.ok){
        const msg = (body && body.error) ? body.error : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return body;
    }
    
    function renderList(){
      const el = $("peopleList");
      el.innerHTML = "";
      if(state.people.length === 0){
        el.innerHTML = `<div class="muted">No people yet. Import a GEDCOM or create a person.</div>`;
        return;
      }
      for(const p of state.people){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="name">${escapeHtml(fullName(p))}</div>
          <div class="meta">ID ${p.id}${p.xref ? " ‚Ä¢ " + escapeHtml(p.xref) : ""}${p.sex ? " ‚Ä¢ " + escapeHtml(p.sex) : ""}</div>
        `;
        div.onclick = async () => {
          state.selected = p;
          const depth = parseInt($('depthSelect').value || 2);
          await window.TreeV2.loadGraph(p.id, depth);
          $('btnRefresh').disabled = false;
        };
        el.appendChild(div);
      }
    }
    
    async function refreshPeople(q=""){
      const url = q ? `/api/people?q=${encodeURIComponent(q)}` : "/api/people";
      state.people = await api(url);
      renderList();
    }
    
    async function importGedcom(file){
      const fd = new FormData();
      fd.append("file", file);
      const res = await api("/api/import/gedcom", { method:"POST", body: fd });
      alert(`Imported: ${res.imported.people} people, ${res.imported.families} families`);
      await refreshPeople();
    }
    
    function wire(){
      $("search").addEventListener("input", async () => {
        await refreshPeople(($("search").value || "").trim());
      });
      
      $("gedcomFile").addEventListener("change", async (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if(!f) return;
        await importGedcom(f);
        ev.target.value = "";
      });
      
      $("depthSelect").addEventListener("change", async () => {
        if (state.selected) {
          const depth = parseInt($('depthSelect').value || 2);
          await window.TreeV2.loadGraph(state.selected.id, depth);
        }
      });

      $("layoutSelect").addEventListener("change", () => {
        window.TreeV2.setLayout($('layoutSelect').value || 'elk');
      });
      
      $("btnRefresh").addEventListener("click", async () => {
        if (state.selected) {
          const depth = parseInt($('depthSelect').value || 2);
          await window.TreeV2.loadGraph(state.selected.id, depth);
        }
      });

      $("btnFit").addEventListener("click", () => {
        window.TreeV2.fit();
      });

      $("btnExportPng").addEventListener("click", () => {
        window.TreeV2.exportPng();
      });

      $("btnFind").addEventListener("click", () => {
        const q = ($('graphSearch').value || '').trim();
        if(q) window.TreeV2.findAndFocus(q);
      });

      $("graphSearch").addEventListener("keydown", (ev) => {
        if(ev.key === 'Enter'){
          const q = ($('graphSearch').value || '').trim();
          if(q) window.TreeV2.findAndFocus(q);
        }
      });
      
      $("btnExportTree").addEventListener("click", () => {
        window.TreeV2.exportTreeData();
      });
      $("btnPrintTree").addEventListener("click", () => {
        window.TreeV2.printTreeView();
      });
    }
    
    (async function init(){
      wire();
      await refreshPeople();
      
      // Check if personId is in URL params
      const params = new URLSearchParams(window.location.search);
      const personId = params.get('personId');
      if (personId) {
        const pid = parseInt(personId);
        const person = state.people.find(p => p.id === pid);
        if (person) {
          state.selected = person;
          const depth = parseInt($('depthSelect').value || 2);
          await window.TreeV2.loadGraph(pid, depth);
          $('btnRefresh').disabled = false;
        }
      }
    })();
  </script>
</body>
</html>
